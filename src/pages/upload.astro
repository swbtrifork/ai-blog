---
import { BlobServiceClient } from "@azure/storage-blob";
import VideoUploader from "../components/VideoUploader.svelte";
import BaseLayout from "../layouts/BaseLayout.astro";

const permalink = new URL("upload", Astro.site).href;

const connectionString = import.meta.env.AZURE_STORAGE_CONNECTION_STRING;
const containerName = import.meta.env.AZURE_STORAGE_CONTAINER_NAME || "videos";

let videos = [];
let error = "";

if (!connectionString) {
  error = "Azure Storage connection string is not configured.";
  console.error(error);
} else {
  try {
    const blobServiceClient =
      BlobServiceClient.fromConnectionString(connectionString);
    const containerClient = blobServiceClient.getContainerClient(containerName);

    if (await containerClient.exists()) {
      const blobItems = [];
      for await (const blob of containerClient.listBlobsFlat()) {
        blobItems.push({
          name: blob.name,
          url: containerClient.getBlockBlobClient(blob.name).url,
          createdOn: blob.properties.createdOn,
          properties: blob.properties,
        });
      }

      videos = blobItems.sort((a, b) => {
        const dateA = a.createdOn ? new Date(a.createdOn).getTime() : 0;
        const dateB = b.createdOn ? new Date(b.createdOn).getTime() : 0;
        return dateB - dateA; // Sort descending (newest first)
      });
    } else {
      error = `Container "${containerName}" does not exist.`;
    }
  } catch (e) {
    error = "Failed to fetch videos from Azure Storage.";
    console.error(e);
  }
}
---

<BaseLayout
  title="Upload Video"
  description="Upload videos to Azure Storage"
  permalink={permalink}
  current="upload"
>
  <article class="content">
    <VideoUploader client:load />
  </article>
  <div class="container">
    <h2 class="title">All Videos</h2>

    {error && <p class="error-message">{error}</p>}

    {!error && videos.length === 0 && <p>No videos found.</p>}

    <div class="video-grid">
      {
        videos.map((video) => (
          <div class="video-card">
            <video controls preload="metadata">
              <source
                src={video.url}
                type={video.properties.contentType || "video/mp4"}
              />
              Your browser does not support the video tag.
            </video>
            <h3>{video.name}</h3>
            <button class="copy-mdx-btn" data-url={video.url}>Copy MDX Tag</button>
          </div>
        ))
      }
    </div>
  </div>
</BaseLayout>

<script>
  function handleCopyMdx(e: Event) {
    const btn = e.target as HTMLButtonElement;
    const url = btn.dataset.url || "";
    const textToCopy = `<video src="${url}" controls></video>`;

    navigator.clipboard.writeText(textToCopy).then(() => {
      btn.textContent = "Copied!";
      setTimeout(() => {
        btn.textContent = "Copy MDX Tag";
      }, 2000);
    }).catch(err => {
      console.error("Failed to copy MDX tag: ", err);
      btn.textContent = "Failed!";
      setTimeout(() => {
        btn.textContent = "Copy MDX Tag";
      }, 2000);
    });
  }

  document.querySelectorAll('.copy-mdx-btn').forEach(btn => {
    btn.addEventListener('click', handleCopyMdx);
  });
</script>

<style>
  .content {
    max-width: 42em;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .title {
    font-family: var(--font-family-serif);
    font-size: 2.2em;
    margin: 1.6em 0 1em 0;
    color: var(--primary-color);
    text-align: center;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    letter-spacing: 0.05em;
  }

  .container {
    padding: 2em;
    width: 100%;
    margin: 0 auto;
    max-width: 1400px; /* Matching Header max-width */
  }

  .error-message {
    color: red;
    font-weight: bold;
  }

  .video-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 2rem;
    margin-top: 2rem;
  }

  .video-card {
    border: 1px solid var(--text-secondary);
    border-radius: 8px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .video-card video {
    width: 100%;
    height: auto;
    aspect-ratio: 16/9;
    background: #000;
  }

  .video-card h3 {
    padding: 1rem;
    margin: 0;
    font-size: 1rem;
    word-break: break-all;
  }

  .copy-mdx-btn {
    padding: 0.5rem 1rem;
    margin: 0 1rem 1rem 1rem; /* Add margin to separate from video and text */
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 0.875rem;
    font-family: var(--font-family-sans);
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s, box-shadow 0.2s, transform 0.2s;
  }

  .copy-mdx-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(84, 142, 155, 0.3);
  }

  .copy-mdx-btn:active {
    transform: translateY(0);
    box-shadow: none;
  }
</style>
